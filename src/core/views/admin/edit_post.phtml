
<?php
global $db;
$p_list = ['title', 'post', 'publish' ];
if ($_SERVER['REQUEST_METHOD'] === 'POST') if ($_POST['submit-btn']=='submited'){
    $title = $_POST['p_title'];
    $text = $_POST['p_post'];
    $publish = $_POST['p_publish']?:0;
    $slugify = new Cocur\Slugify\Slugify();
    $slug = $slugify->slugify($title);
    $args = [$title,$text,$publish,$slug];
    if ($id == "new") {
        $db->query("INSERT INTO post(title,post,publish,slug) VALUES(?,?,?,?)",$args);
        $id = $db->insert_id;
    }
    else {
        $db->query("UPDATE post SET title=?,post=?,publish=?,slug=? WHERE id=$id",$args);
    }
    echo "<div class='alert success'>Changes have been saved successfully!</div>";
}

if ($id == 'new') {
    $p = (object)['img'=>'','title'=>'','post'=>'','publish'=>1,'id'=>(isset($_POST['p_id'])?$_POST['p_id']:0)];
}
else {
    $ql="SELECT id,title,post,publish,
        (SELECT value FROM postmeta WHERE post_id=post.id AND vartype='thumbnail') as img
        FROM post WHERE id=$id";
    $res = $db->query($ql);
    if ($res) $p=mysqli_fetch_object($res); else die("The post '$id' could not be found in db!");
}

?>

<div class="col-md-12">
<form id="postForm" method="post" class="g-form" action="admin/posts/<?=($p->id?:'new')?>">
    <input value="<?=($p->id?:'new')?>" name="p_id" type="hidden"/>

    <div class="col-md-12">
        <label class="col-md-2">Title</label>
        <input class="col-md-10" value="<?=$p->title?>" name="p_title"/>
    </div>

    <div class="col-md-12">
        <label class="col-md-2">Thumbnail</label>
        <input class="col-md-10" value="<?=$p->img?>" name="p_thumbnail"/>
    </div>

    <div class="col-md-12">
        <label class="col-md-2">Tags</label>
        <input class="col-md-10" placeholder="values seperated by comma" />
    </div>
    <div class="col-md-12">
        <label class="col-md-2">Category</label>
        <select class="select2" multiple class="col-md-10 gm-10" style="width:83.333%">
            <option value="1">Category1</option>
            <option value="1">Category2</option>
            <option value="1">Category3</option><option value="1">Category4</option> </select>
    </div>

    <div class="col-md-12">
        <label class="col-md-3">Publish<input type="checkbox" name="p_publish" value="1"<?=($p->publish=='1'?' checked':'')?>></label>
    </div>
    <hr>

    <div class="col-md-12">
        <label class="col-md-12">Text</label><br>
        <textarea name="p_post"><?=$p->post?></textarea>
    </div>

    <div class="col-md-12">
        <div class="btn-group">
            <input type="submit" name="submit-btn" class="btn btn-primary" onclick="this.value='submited'" />
        </div>
    </div>
</form>
</div>

<script src="libs/tinymce/js/tinymce/tinymce.min.js"></script>
<script>
//cdn.tinymce.com/4/tinymce.min.js
//tinymce.init({ selector:'textarea' });
tinymce.init({
  selector: '[name=p_post]',
  mode: 'none',
  height: 300,
  //theme: 'modern',
  plugins: [
    'advlist autolink lists link image charmap print  hr anchor pagebreak',
    'searchreplace wordcount  visualchars code ',
    'insertdatetime media nonbreaking table contextmenu ', //directionality fullscreen visualblocks preview
    'template paste textcolor colorpicker textpattern imagetools codesample toc' //example_dependency emoticons
],
  toolbar1: 'styleselect | forecolor backcolor bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link media image codesample',
  //theme_advanced_buttons3_add : "visualchars",
  //toolbar2: 'print preview  |   emoticons | table',
  //image_advtab: true,
  templates: <?php echo json_encode((isset($templates)?$templates:[])); ?>,
  document_base_url : "//localhost/gila/",
  content_css: <?php echo json_encode(isset($content_css)?$content_css:[]); ?>
    //'//localhost/gila/libs/bootstrap/bootstrap.min.css',
    //'//localhost/gila/libs/font-awesome/css/font-awesome.min.css',
    //'//localhost/gila/themes/bs-property/style.css',
    //'//fonts.googleapis.com/css?family=Lato:300,300i,400,400i',
    //'//www.tinymce.com/css/codepen.min.css'
 });

 var requiredRes = {
   "sweetalert": {
     js: "sweetalert/sweetalert.min.js",
     css: "sweetalert/sweetalert.css",
     dep: "bootstrap"
   },
   'webui-popover': {
     js: "popup/jquery.webui-popover.min.js",
     css: "popup/jquery.webui-popover.min.css",
     dep: "jquery"
   }
}
g.require('libs/jquery/jquery-2.2.4.min.js',function(){
    g.loadCSS('libs/select2/select2.min.css');
    g.require(['libs/select2/select2.min.js'],function(){
        $('.select2').select2();
    })
})
</script>
